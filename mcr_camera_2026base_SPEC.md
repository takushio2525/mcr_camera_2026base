# mcr_camera_2026base_SPEC

## 1. 概要
GR-PEACH (RZ/A1H) をベースとしたマイクロマウス／ロボットカメラーカー向け制御用ベースプロジェクト。
割り込み駆動のアーキテクチャを採用し、Onboardクラスを用いたLEDラッチ表示制御と、1msタイマーによる周期的な処理基盤を提供します。

## 3. 目的
本ベースプロジェクトを活用し、カメラモジュールやモータ制御といった高機能なロボット制御基盤を効率的に実装できるようにする。
また、処理ロジックを1ms周期の割り込みハンドラ等に統合し、ハードウェア操作をドライバラッパー経由に集約することで、簡潔で見通しの良いコードにする。

## 4. 機能・UXフロー
- 電源投入後、C/C++初期化ルーチンが走り、`main()` が実行される。
- `main()` 内でLEDや各種ペリフェラル（タイマーなど）を初期化し、ループ待機状態となる。
- 実処理は `OSTM0` による1ms周期タイマー割り込み（`ostm0_interrupt_callback`）から起動される。
- 1ms割り込み内で実行される `Onboard::update()` などのハードウェア処理用メソッドにより、遅延なく一括してGPIO等へ反映（ラッチ方式）される。

## 5. データ構造
- 変数 `g_timer_1ms`: 全体で共有するグローバルな1msカウンタ
- `Onboard` クラス内ラッチバッファ: LEDの状態を保存し、`update()` 呼び出し時に一括でポート出力を更新する。

## 6. 技術スタック
- **ターゲット:** GR-PEACH (Renesas RZ/A1H MCU)
- **言語:** C / C++
- **開発環境:** e2 studio / VSCode DevContainer (LaTeXドキュメント用)
- **コンパイラ:** GCC for Renesas ARM
- **割り込みコントローラ:** GIC (Generic Interrupt Controller)
- **タイマー:** OSTM0 (OS Timer 0) -> 1msインターバルとして使用

## 7. ファイル構成

| ファイル | 役割 |
|----------|------|
| `.devcontainer/` | LaTeXドキュメントビルド用のコンテナ環境設定 |
| `src/mcr_camera_2026base.cpp` | メインの初期化と 1msタイマー設定、コールバックを実装 |
| `src/core/IModule.h` | 全モジュール共通の基底インターフェース |
| `src/drivers/Onboard.h` | オンボードのLED / SWを抽象化したラッチ管理ドライバ の定義 |
| `src/drivers/Onboard.cpp` | Onboardクラスのハードウェア（GPIO）操作の実装 |
| `src/drivers/Serial.h` | デバッグ用シリアル通信（即時出力）ドライバの定義 |
| `src/drivers/Serial.cpp` | シリアル通信のハードウェア（SCIF）操作とprintf機能の実装 |
| `generate/inthandler.c` | e2 studio 生成の中断ハンドラ実装ファイル（OSTM0コールバックをフック） |
| `doc/main.tex` | プロジェクト等の全体・旧版仕様や関連詳細資料 |

### 機能とファイルの対応表

| 機能 | メインファイル | 関連ファイル |
|------|----------------|--------------|
| オンボードLED・SW操作 | `src/drivers/Onboard.cpp` | `src/drivers/Onboard.h`, `mcr_camera_2026base.cpp` |
| デバッグシリアル通信 | `src/drivers/Serial.cpp` | `src/drivers/Serial.h`, `mcr_camera_2026base.cpp` |
| 1msタイマー割り込み処理 | `src/mcr_camera_2026base.cpp` | `generate/inthandler.c` |

## 8. 詳細設計
- **`IModule`**: 全ドライバおよびロジックモジュールの共通インターフェース。`init()`と`update()`を定義。
- **`Onboard コンストラクタ`**: ラッチバッファの初期化のみ。
- **`Onboard::setUserLed(val)`**: USER LEDのバッファ状態を1または0に保存。ハードウェアにはまだ反映しない。
- **`Onboard::setColorLed(r, g, b)`**: フルカラーLED（RGB）のバッファ状態を保存。ハードウェアにはまだ反映しない。
- **`Onboard::update()`**: LEDバッファ状態をまとめ、GR-PEACHの対象GPIOピン（Low Active）へ実際に出力する。
- **`Onboard::sw()`**: SWのプッシュ状態をポーリングで監視し、押下時1(Active-High)を返す。
- **`g_onboard`**: `Onboard`クラスのグローバルインスタンス。割り込みハンドラ等各所からハードウェア操作を行うために使用。
- **`initOSTM0()`**: RZ/A1HのOSTM0を1ms用に設定し、GIC(INTC)へ登録。
- **`ostm0_interrupt_callback()`**: `INT_Excep_OSTMI0` から呼ばれ、実時間をカウント(`g_timer_1ms`)し、`g_onboard` 経由でLED制御を行う。
- **`INT_Excep_IRQ()`**: GIC(INTC)を用いたベクタ割り込みディスパッチャ。ICCIARから要因IDを取得し、`RelocatableVectors` から適切なハンドラへ分岐・EIOを通知する実装。
- **`Serial::init()`**: SCIFモジュールの初期化とボーレート（115200bps等）設定を行う。
- **`Serial::printf(fmt, ...)`**: 書式付き文字列をフォーマットし、送出可能になるまでポーリング待機しながらSCIFへ1文字ずつ即時出力する。
- **`Serial::update()`**: IModule準拠のためのダミー関数（何も行わない）。
- **`g_serial`**: `Serial`クラスのグローバルインスタンス。デバッグ出力の用途として各所で使用する。

## 24. 修正履歴

### 2026-02-26 20:18: LaTeXコンパイル用DevContainer環境の統合
**変更内容:**
- プロジェクト直下に `.devcontainer` ディレクトリを追加し、LaTeX Workshop 設定を含む DevContainer を構築。
- プロジェクト直下に `.gitignore` を追加し、TeX の中間ビルド除外設定を追加。
- 仕様書の技術スタックとファイル構成を更新。

**解消した問題/不満:**
- どこでも `doc/main.tex` を同一条件でコンパイルできる環境がなかった問題。

**解決方法:**
- 既存の `tex_devcontainer` の設定を本プロジェクトに統合し、VSCode で開くだけでコンパイルできる環境を用意しました。

### 2026-02-24 21:15: シリアル通信（Serial）クラス要件の定義
**変更内容:**
- 開発・デバッグ用にシリアル通信を行う `Serial` クラスの仕様を定義。
- `doc/main.tex` および `mcr_camera_2026base_SPEC.md` にクラスの設計を追加。

**解消した問題/不満:**
- 動作中の変数値やクラッシュ直前の状態を知るためのデバッグ出力手段がなかった問題。
- 他モジュール用のラッチ方式（`update()`呼出時の一括反映）を採用すると、クラッシュ時にバッファ内の文字列が出力されない懸念があった問題。

**解決方法:**
- 単純なポーリング待機による即時出力機能（`printf`）を持つクラスとし、ラッチバッファを使用しないアーキテクチャとした。これにより、関数が呼ばれた瞬間に確実に端末へ出力される。

### 2026-02-24 21:05: OnboardのLED制御メソッド（setLed）の分割
**変更内容:**
- `Onboard` クラスの `setLed(id, val)` メソッドを廃止し、`setUserLed(val)` と `setColorLed(r, g, b)` に分割。
- `mcr_camera_2026base.cpp` における呼び出し部を新しいメソッドを使用するように修正。

**解消した問題/不満:**
- ユーザーLEDとRGBフルカラーLEDが同じ `setLed` メソッドでID指定により操作されていたため、直感的でなく可読性が低かった問題。

**解決方法:**
- 役割ごとに専用のメソッド（単一のON/OFF制御と、RGBの3色同時制御）を用意することで、呼び出し側のコードを簡潔にし、意図を明確にしました。

### 2026-02-24 20:55: IModuleインターフェース実装とOnboardクラスのグローバル化

**変更内容:**
- `src/core/IModule.h` を新規作成し、基底インターフェース `IModule` を定義。
- `src/drivers/Onboard.h`, `Onboard.cpp` に `IModule` を継承させ、初期化処理を `init()` メソッドへ移行。
- `src/mcr_camera_2026base.cpp` で `Onboard` インスタンス（`g_onboard`）をグローバル化し、`main` の先頭で `init()` を呼び出す構造に変更。

**解消した問題/不満:**
- オブジェクト指向ベースの共通インターフェース（`IModule`）に準拠させるためのアーキテクチャ整備。
- インスタンスが `main` のローカル変数だったため、ポインタ経由で間接参照していた構造を、明確なグローバルインスタンスに変更し可読性を向上。

**解決方法:**
- `IModule`（`doc/main.tex` 定義に準拠）を実装し各ドライバに適応。グローバル確保でメモリ配置を確定させ、直接メソッドを呼ぶことで簡素化・安全性向上を図った。

### 2026-02-24 20:45: 個別割り込みハンドラからの不正なリターン命令によるクラッシュ修正
**変更内容:**
- `generate/interrupt_handlers.h` に定義されている数百個の各種ペリフェラル割り込みハンドラ（`INT_Excep_OSTMI0` など）から、`__attribute__((interrupt))` の指定を削除し `__attribute__((used))` のみに修正しました。（※上位の基本例外である IRQ, FIQ, SWI 等はそのまま残しています）

**解消した問題/不満:**
- タイマーが正しく起動し、IRQディスパッチャ（先ほど追加したGICのハンドラ）から個別のOSTMコールバックへうまく飛んだ直後、そこから元の処理へ戻るタイミングでプログラムが完全にクラッシュ（フリーズ）してしまう問題。

**解決方法:**
- ARM Cortex-Aのコンパイラ挙動において、`__attribute__((interrupt))` が付与された関数は、通常のC言語関数の戻り命令（`bx lr`）ではなく、割り込み専用の特殊な戻り命令（`subs pc, lr, #4`）でコンパイルされます。
- 現状のアーキテクチャでは、**すでに最上位の「IRQハンドラ」がこの特殊な戻り処理を行っており**、個別のタイマー割り込み関数（`INT_Excep_OSTMI0` 等）は単なるC言語の関数として呼ばれていました。それにもかかわらず、ヘッダファイル内で全てのハンドラに「私は割り込み関数である」という属性が付与されていたため、**普通のC関数として呼ばれたのに特殊な割り込み戻り命令を実行**してしまい、プログラムカウンタ（PC）がおかしなアドレスに飛んでクラッシュしていました。
- これを削除することで、無事に元の main の無限ループへ処理が復帰するようになります。

### 2026-02-24 17:55: タイマー割り込みが1回しか発生しなくなる不具合の修正
**変更内容:**
- `src/mcr_camera_2026base.cpp` において、OSTM0の制御レジスタ `OSTMnCTL` を `0x00` から `0x01` に修正。

**解消した問題/不満:**
- タイマー待機処理の追加によりレジスタの書き換えが成功するようになった途端、割り込みが全く発生しなくなった問題。

**解決方法:**
- 以前の修正で「コンペアマッチ時に割り込み要求を発生」させるつもりで `OSTMnCTL` を `0x00` にしてしまっていましたが、RZ/A1Hのハードウェア仕様では `MD0=0` は「カウント**開始時**のみ割り込み発生」という単発動作の設定でした。`MD0=1` が正しい「コンペアマッチ時（周期ごと）に割り込み発生」であるため、`0x01` に修正しました。

### 2026-02-24 17:45: OSTMタイマー周期(コンペアレジスタ)がハードに反映されない問題の修正
**変更内容:**
- `src/mcr_camera_2026base.cpp` において、OSTM0を停止(OSTMnTT=1)した直後に `OSTMnTE == 0` になるのを待つ `while` ループを追加。
- コンペアマッチ値を本来の `33,333` (1ms相当) に戻し、実測で10倍早まっていた現象を解消。

**解消した問題/不満:**
- 割り込み周期を1msに設定（コンペアレジスタ書き換え）したにも関わらず、完全に無視されて、ブートローダー等が初期化した0.1ms周期のまま動いてしまっていた問題。

**解決方法:**
- ハードウェアの仕様により、OSTMタイマーが「完全に停止（TEビットが0）」していない状態でコンペアレジスタ（CMP）を書き換えても値が無視されます。そのため、TTレジスタで停止要求を出した後、TEレジスタが0になるまでポーリングで待機してから値を書き込むようにし、確実に1ms周期（33,333カウント）が反映されるようにしました。

### 2026-02-24 17:10: 割り込み動作の根本原因（Cortex-A9アーキテクチャ定義）の修正
**変更内容:**
- `generate/start.S` にて、IRQモード用のスタックポインタ初期化処理を追加。
- `src/mcr_camera_2026base.cpp` の OSTM0初期化にて、GICの `ICDICFR8` を設定し OSTM0 (IRQ134) をエッジトリガに変更。
- `src/mcr_camera_2026base.cpp` の OSTM0制御レジスタ設定で `OSTMnCTL = 0x00` (コンペアマッチで割り込み) に修正。

**解消した問題/不満:**
- 割り込みハンドラが実装され、VBARも設定されていたが、依然として割り込みが発生するとプログラムがフリーズしてしまう問題。

**解決方法:**
1. **IRQスタック未定義の修正:** Cortex-A9では割り込み時に自動でIRQモードに遷移しますが、IRQモード用のスタックポインタ（SP）が初期化されていなかったため、C言語のハンドラがスタック（ローカル変数など）を使おうとした瞬間にクラッシュしていました。4KBのIRQ専用スタックを確保し解決しました。
2. **GICエッジトリガ設定:** GICはデフォルトでレベルトリガ設定になっていますが、OSTM0はパルス状のエッジ割り込みを発行します。GICの各種設定レジスタ (`ICDICFR8`) を書き換え、正しくエッジを検知できるように変更しました。
3. **タイマー制御レジスタの最適化:** 1回限りの割り込み設定となっていた可能性のある `OSTMnCTL` を `0x00` とし、正しくマッチ時に毎回割り込みが発生するようにしました。

### 2026-02-24 16:55: CPUベクタベースアドレス(VBAR)の初期化を追加
**変更内容:**
- `generate/start.S` のアセンブリスタートアップコード内に、`vector_table` のアドレスを `VBAR` (Vector Base Address Register) に設定する処理を追加しました。

**解消した問題/不満:**
- IRQハンドラは実装したものの、Cortex-A9のCPUに対して「自前の割り込みベクタテーブルがどこにあるか」を教えていなかったため、割り込み発生時にCPUがデフォルトの `0x00000000` 付近（BootROMなど）へ飛んでしまいフリーズする問題。

**解決方法:**
- `mcr p15, 0, r0, c12, c0, 0` インストラクションを用いて、`vector_table` のベースアドレスをVBARへ登録し、割り込み発生時に正しく自作のIRQディスパッチャ（先ほど追加したもの）へジャンプするようにしました。

### 2026-02-24 16:45: GIC割り込みディスパッチャ（IRQ）の実装
**変更内容:**
- `generate/inthandler.c` の空関数だった `INT_Excep_IRQ()` に、GICからの割り込み要因取得と `RelocatableVectors` による個別ハンドラへの分岐処理、さらにEOI (End of Interrupt) 応答処理を追加しました。
- `mcr_camera_2026base_SPEC.md` の詳細設計に `INT_Excep_IRQ()` の説明を追記しました。

**解消した問題/不満:**
- タイマー割り込み（OSTM0）などの割り込み要求が発生しても、ベクタテーブルから呼ばれる大元のIRQディスパッチャが空実装であったため、割り込みハンドラが実行されず、さらにGIC側でも割り込み要求がクリアされないという問題。オンボードLEDが点滅しない原因となっていました。

**解決方法:**
- ARM Cortex-A9向けの正しいGIC IRQディスパッチロジック（ICCIARの読み出し〜ハンドラ呼び出し〜ICCEOIRへの書き込み）を実装し、各種タイマ等の個別割り込みハンドラが正しく実行されるようにしました。

### 2026-02-24 16:15: オンボードクラスのインスタンス化対応とGPIO初期化修正
**変更内容:**
- `src/drivers/Onboard.cpp` のスイッチ入力初期化に欠けていたPIPC6やPBDC6のクリア処理を追加。
- 動作安定化のため静的メソッドによる基盤操作から、インスタンスを生成（`Onboard onboard;`）し `g_onboard` ポインタ経由で割り込みハンドラから操作するオブジェクト指向構造にリファクタリング。
**解決方法:**
- Mbed由来のプロジェクト構造を参考に、より安全な初期化シーケンスと呼び出し経路に改修。

### 2026-02-24 16:04: オンボードクラス＆1msタイマーの実装

**変更内容:**
- `src/drivers/Onboard.h`, `Onboard.cpp` を追加し、GR-PEACH上のLEDやUSERスイッチのラッチ方式ドライバを実装。
- `src/mcr_camera_2026base.cpp` に `1ms` 割り込み用の `initOSTM0()` と `ostm0_interrupt_callback()` を実装。
- `generate/inthandler.c` 内の `INT_Excep_OSTMI0` 中断ハンドラから `ostm0_interrupt_callback` をコールするよう改修。
- `mcr_camera_2026base_SPEC.md` （本仕様書）を新規作成。

**解決方法:**
- mcr_camera_test1のコードを反映し、Timer0割り込みベースでのループ周期駆動アーキテクチャを確立。
